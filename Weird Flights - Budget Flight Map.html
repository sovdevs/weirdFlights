<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weird Flights - Budget Flight Map</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #fff;
        }
        
        .container {
            display: flex;
            height: 100vh;
        }
        
        /* Sidebar */
        .sidebar {
            width: 380px;
            background: #111;
            border-right: 1px solid #333;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .header {
            padding: 20px;
            border-bottom: 1px solid #333;
        }
        
        .header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .header p {
            color: #888;
            font-size: 14px;
        }
        
        /* Filters */
        .filters {
            padding: 16px 20px;
            border-bottom: 1px solid #333;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .filter-row {
            display: flex;
            gap: 10px;
        }
        
        .filter-group {
            flex: 1;
        }
        
        .filter-group label {
            display: block;
            font-size: 11px;
            text-transform: uppercase;
            color: #666;
            margin-bottom: 4px;
            letter-spacing: 0.5px;
        }
        
        select, input {
            width: 100%;
            padding: 10px 12px;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 6px;
            color: #fff;
            font-size: 14px;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: #4a9eff;
        }
        
        /* Results */
        .results {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }
        
        .results-header {
            padding: 8px 8px 16px;
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .route-card {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            padding: 14px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .route-card:hover {
            border-color: #4a9eff;
            background: #1f1f1f;
        }
        
        .route-card.selected {
            border-color: #4a9eff;
            background: #1a2a3a;
        }
        
        .route-airports {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        
        .airport-code {
            font-size: 18px;
            font-weight: 600;
        }
        
        .route-arrow {
            color: #666;
        }
        
        .route-price {
            font-size: 24px;
            font-weight: 700;
            color: #4aff91;
        }
        
        .route-meta {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #666;
            margin-top: 8px;
        }
        
        .airline-badge {
            background: #2a2a2a;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            text-transform: uppercase;
        }
        
        /* Map */
        .map-container {
            flex: 1;
        }
        
        #map {
            width: 100%;
            height: 100%;
            background: #0a0a0a;
        }
        
        /* Custom Leaflet styles */
        .leaflet-container {
            background: #0a0a0a;
        }
        
        .airport-marker {
            background: #4a9eff;
            border: 2px solid #fff;
            border-radius: 50%;
            width: 12px;
            height: 12px;
        }
        
        .leaflet-popup-content-wrapper {
            background: #1a1a1a;
            color: #fff;
            border-radius: 8px;
        }
        
        .leaflet-popup-tip {
            background: #1a1a1a;
        }
        
        .popup-content h3 {
            margin-bottom: 8px;
        }
        
        .popup-content .price {
            font-size: 20px;
            color: #4aff91;
            font-weight: 700;
        }
        
        .popup-content a {
            display: inline-block;
            margin-top: 10px;
            padding: 6px 12px;
            background: #4a9eff;
            color: #fff;
            text-decoration: none;
            border-radius: 4px;
            font-size: 12px;
        }
        
        /* Loading state */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .no-results {
            text-align: center;
            padding: 40px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <div class="header">
                <h1>✈️ Weird Flights</h1>
                <p>Budget-first flight search</p>
            </div>
            
            <div class="filters">
                <div class="filter-row">
                    <div class="filter-group">
                        <label>From Region</label>
                        <select id="originRegion">
                            <option value="">Any</option>
                            <option value="europe">Europe</option>
                            <option value="north_america">North America</option>
                            <option value="se_asia">SE Asia</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>To Region</label>
                        <select id="destRegion">
                            <option value="">Any</option>
                            <option value="europe">Europe</option>
                            <option value="north_america">North America</option>
                            <option value="se_asia">SE Asia</option>
                        </select>
                    </div>
                </div>
                <div class="filter-row">
                    <div class="filter-group">
                        <label>Passenger Type</label>
                        <select id="passengerType">
                            <option value="adult">Adult</option>
                            <option value="child" disabled>Child (Coming soon)</option>
                        </select>
                    </div>
                </div>
                <div class="filter-row">
                    <div class="filter-group">
                        <label>Max Price (£)</label>
                        <input type="number" id="maxPrice" placeholder="e.g. 500">
                    </div>
                </div>
            </div>
            
            <div class="results">
                <div class="results-header">
                    <span id="resultsCount">0</span> routes found
                </div>
                <div id="routesList">
                    <div class="loading">Loading routes...</div>
                </div>
            </div>
        </aside>
        
        <main class="map-container">
            <div id="map"></div>
        </main>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // Airport coordinates and names lookup
        const AIRPORT_DATA = {
            'LGW': { name: 'London Gatwick', lat: 51.1537, lon: -0.1821 },
            'BKK': { name: 'Bangkok Suvarnabhumi', lat: 13.6900, lon: 100.7501 },
            'JFK': { name: 'New York JFK', lat: 40.6413, lon: -73.7781 },
            'LAX': { name: 'Los Angeles', lat: 33.9425, lon: -118.4081 },
            'LHR': { name: 'London Heathrow', lat: 51.4700, lon: -0.4543 },
            'CDG': { name: 'Paris Charles de Gaulle', lat: 49.0097, lon: 2.5479 },
            'AMS': { name: 'Amsterdam', lat: 52.3086, lon: 4.7639 },
            'DXB': { name: 'Dubai', lat: 25.2528, lon: 55.3644 },
            'SIN': { name: 'Singapore', lat: 1.3521, lon: 103.8198 },
            'HND': { name: 'Tokyo Haneda', lat: 35.5494, lon: 139.7798 },
            'PEK': { name: 'Beijing Capital', lat: 40.0799, lon: 116.5850 },
            'HKG': { name: 'Hong Kong', lat: 22.3080, lon: 113.9185 },
            'ICN': { name: 'Seoul Incheon', lat: 37.4602, lon: 126.4407 }
        };

        // Config
        const API_BASE = 'http://localhost:8000';

        // State
        let map;
        let routeLines = [];
        let airportMarkers = {};
        let selectedRoute = null;
        let allRoutes = [];

        // Initialize map
        function initMap() {
            map = L.map('map', {
                center: [30, 20],
                zoom: 2,
                minZoom: 2,
                maxZoom: 8,
                worldCopyJump: true
            });

            // Dark tile layer
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);
        }

        // Fetch routes from API
        async function fetchRoutes(filters = {}) {
            try {
                const response = await fetch('flights.json');
                const data = await response.json();

                // Data is a direct array, add airport info
                const routes = data.map(route => ({
                    ...route,
                    lowest_price: route.price,
                    origin_name: AIRPORT_DATA[route.origin]?.name || route.origin,
                    destination_name: AIRPORT_DATA[route.destination]?.name || route.destination,
                    origin_lat: AIRPORT_DATA[route.origin]?.lat,
                    origin_lon: AIRPORT_DATA[route.origin]?.lon,
                    destination_lat: AIRPORT_DATA[route.destination]?.lat,
                    destination_lon: AIRPORT_DATA[route.destination]?.lon
                }));

                // Apply filters
                return routes.filter(route => {
                    if (filters.maxPrice && route.price > parseFloat(filters.maxPrice)) return false;
                    return true;
                });
            } catch (error) {
                console.error('Error fetching routes:', error);
                return [];
            }
        }

        // Fetch airports
        async function fetchAirports() {
            try {
                const response = await fetch(`${API_BASE}/api/airports`);
                const data = await response.json();
                return data.airports || [];
            } catch (error) {
                console.error('Error fetching airports:', error);
                return [];
            }
        }
        
        // Clear map overlays
        function clearMap() {
            routeLines.forEach(line => map.removeLayer(line));
            routeLines = [];
            Object.values(airportMarkers).forEach(marker => map.removeLayer(marker));
            airportMarkers = {};
        }
        
        // Draw routes on map
        function drawRoutes(routes) {
            clearMap();
            
            const airportsInUse = new Set();
            
            routes.forEach(route => {
                if (!route.origin_lat || !route.destination_lat) return;
                
                airportsInUse.add(route.origin);
                airportsInUse.add(route.destination);
                
                // Calculate color based on price (green = cheap, red = expensive)
                const priceRatio = Math.min(route.lowest_price / 1000, 1);
                const hue = 120 - (priceRatio * 120); // 120 = green, 0 = red
                const color = `hsl(${hue}, 70%, 50%)`;
                
                // Draw route line
                const line = L.polyline([
                    [route.origin_lat, route.origin_lon],
                    [route.destination_lat, route.destination_lon]
                ], {
                    color: color,
                    weight: 2,
                    opacity: 0.6,
                    dashArray: '5, 10'
                }).addTo(map);
                
                // Popup content
                line.bindPopup(`
                    <div class="popup-content">
                        <h3>${route.origin} → ${route.destination}</h3>
                        <div>${route.origin_name} → ${route.destination_name}</div>
                        <div class="price">£${route.lowest_price}</div>
                        <div style="margin-top: 5px; color: #888;">${route.departure_date}</div>
                        <div style="margin-top: 5px; color: #888;">${route.airline.toUpperCase()}</div>
                    </div>
                `);
                
                line.on('mouseover', function() {
                    this.setStyle({ weight: 4, opacity: 1 });
                });
                line.on('mouseout', function() {
                    this.setStyle({ weight: 2, opacity: 0.6 });
                });
                
                routeLines.push(line);
            });
            
            // Add airport markers
            routes.forEach(route => {
                if (!airportMarkers[route.origin] && route.origin_lat) {
                    const marker = L.circleMarker([route.origin_lat, route.origin_lon], {
                        radius: 6,
                        fillColor: '#4a9eff',
                        color: '#fff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(map);
                    marker.bindTooltip(route.origin_name || route.origin);
                    airportMarkers[route.origin] = marker;
                }
                
                if (!airportMarkers[route.destination] && route.destination_lat) {
                    const marker = L.circleMarker([route.destination_lat, route.destination_lon], {
                        radius: 6,
                        fillColor: '#4a9eff',
                        color: '#fff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(map);
                    marker.bindTooltip(route.destination_name || route.destination);
                    airportMarkers[route.destination] = marker;
                }
            });
        }
        
        // Render route list
        function renderRouteList(routes) {
            const container = document.getElementById('routesList');
            document.getElementById('resultsCount').textContent = routes.length;

            if (routes.length === 0) {
                container.innerHTML = '<div class="no-results">No routes found</div>';
                return;
            }

            container.innerHTML = routes.map((route, index) => `
                <div class="route-card" data-index="${index}">
                    <div class="route-airports">
                        <span class="airport-code">${route.origin}</span>
                        <span class="route-arrow">→</span>
                        <span class="airport-code">${route.destination}</span>
                        <span class="route-price">£${route.lowest_price}</span>
                    </div>
                    <div class="route-meta">
                        <span>${route.origin_name || route.origin} → ${route.destination_name || route.destination}</span>
                        <span class="airline-badge">${route.airline}</span>
                    </div>
                </div>
            `).join('');

            // Add click handlers
            container.querySelectorAll('.route-card').forEach((card, index) => {
                card.addEventListener('click', () => {
                    const route = routes[index];
                    if (route.origin_lat && route.destination_lat) {
                        map.fitBounds([
                            [route.origin_lat, route.origin_lon],
                            [route.destination_lat, route.destination_lon]
                        ], { padding: [50, 50] });

                        // Highlight line
                        routeLines[index]?.openPopup();
                    }

                    // Update selection UI
                    container.querySelectorAll('.route-card').forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                });
            });
        }
        
        // Load and display data
        async function loadData() {
            const filters = {
                originRegion: document.getElementById('originRegion').value,
                destRegion: document.getElementById('destRegion').value,
                maxPrice: document.getElementById('maxPrice').value
            };

            let routes = await fetchRoutes(filters);
            // Sort by price (low to high)
            routes = routes.sort((a, b) => a.price - b.price);
            allRoutes = routes;
            renderRouteList(routes);
            drawRoutes(routes);
        }
        
        // Event listeners
        document.getElementById('originRegion').addEventListener('change', loadData);
        document.getElementById('destRegion').addEventListener('change', loadData);
        document.getElementById('passengerType').addEventListener('change', loadData);
        document.getElementById('maxPrice').addEventListener('input', debounce(loadData, 300));
        
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }
        
        // Initialize
        initMap();
        loadData();
    </script>
</body>
</html>
